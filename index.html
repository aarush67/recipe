<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Recipe Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/Babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 min-h-screen flex items-center justify-center p-4">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      state = { hasError: false };
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      render() {
        if (this.state.hasError) {
          return <h1 className="text-white text-center">Something went wrong. Please refresh.</h1>;
        }
        return this.props.children;
      }
    }

    // Cookie helper functions
    const setCookie = (name, value, days) => {
      try {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${expires.toUTCString()};path=/`;
      } catch (err) {
        console.error('Error setting cookie:', err);
      }
    };

    const getCookie = (name) => {
      try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
        return null;
      } catch (err) {
        console.error('Error getting cookie:', err);
        return null;
      }
    };

    const App = () => {
      const [ingredients, setIngredients] = useState('');
      const [dietary, setDietary] = useState('none');
      const [cuisine, setCuisine] = useState('none');
      const [recipe, setRecipe] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [recipeHistory, setRecipeHistory] = useState([]);
      const [generationsLeft, setGenerationsLeft] = useState(3);

      // Load cookies and check generation limit
      useEffect(() => {
        try {
          const savedRecipes = getCookie('recipes') || [];
          setRecipeHistory(savedRecipes);

          const limitData = getCookie('generationLimit') || { count: 0, date: new Date().toDateString() };
          const today = new Date().toDateString();

          if (limitData.date !== today) {
            setCookie('generationLimit', { count: 0, date: today }, 1);
            setGenerationsLeft(3);
          } else {
            setGenerationsLeft(3 - limitData.count);
          }
        } catch (err) {
          setError('Error loading cookies. Please try again.');
          console.error(err);
        }
      }, []);

      const handleGenerateRecipe = async () => {
        if (generationsLeft <= 0) {
          setError('Daily limit reached! Try again tomorrow.');
          return;
        }

        if (!ingredients.trim()) {
          setError('Please enter at least one ingredient.');
          return;
        }

        setLoading(true);
        setError(null);
        setRecipe(null);

        const prompt = `Generate a detailed recipe in JSON format with fields: name, ingredients (array), instructions (array), nutritionalInfo (string). Use these ingredients: ${ingredients}. Dietary preference: ${dietary === 'none' ? 'No restrictions' : dietary}. Cuisine type: ${cuisine === 'none' ? 'Any' : cuisine}.`;

        try {
          const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt }),
          });

          if (!response.ok) throw new Error('Failed to fetch recipe');
          const data = await response.json();
          let newRecipe;
          try {
            newRecipe = JSON.parse(data.recipe); // Expect Gemini to return JSON string
          } catch (err) {
            throw new Error('Invalid recipe format from API');
          }

          const updatedHistory = [newRecipe, ...recipeHistory].slice(0, 10);
          setCookie('recipes', updatedHistory, 7);
          setRecipeHistory(updatedHistory);
          setRecipe(newRecipe);

          const limitData = getCookie('generationLimit') || { count: 0, date: new Date().toDateString() };
          const newCount = limitData.count + 1;
          setCookie('generationLimit', { count: newCount, date: new Date().toDateString() }, 1);
          setGenerationsLeft(3 - newCount);
        } catch (err) {
          setError('Error generating recipe. Please try again.');
          console.error('API Error:', err);
        } finally {
          setLoading(false);
        }
      };

      return (
        <ErrorBoundary>
          <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
            <h1 className="text-4xl font-bold text-center text-gray-800 mb-6">AI Recipe Generator</h1>
            <p className="text-center text-gray-600 mb-4">Generations left today: {generationsLeft}</p>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Ingredients (comma-separated)</label>
                <input
                  type="text"
                  value={ingredients}
                  onChange={(e) => setIngredients(e.target.value)}
                  placeholder="e.g., chicken, rice, broccoli"
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Dietary Preference</label>
                <select
                  value={dietary}
                  onChange={(e) => setDietary(e.target.value)}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                  <option value="none">No Preference</option>
                  <option value="vegan">Vegan</option>
                  <option value="vegetarian">Vegetarian</option>
                  <option value="gluten-free">Gluten-Free</option>
                  <option value="keto">Keto</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Cuisine Type</label>
                <select
                  value={cuisine}
                  onChange={(e) => setCuisine(e.target.value)}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                  <option value="none">Any Cuisine</option>
                  <option value="Italian">Italian</option>
                  <option value="Asian">Asian</option>
                  <option value="Mexican">Mexican</option>
                  <option value="Indian">Indian</option>
                </select>
              </div>
            </div>

            <button
              onClick={handleGenerateRecipe}
              disabled={loading || !ingredients.trim() || generationsLeft <= 0}
              className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 transition"
            >
              {loading ? 'Generating...' : 'Generate Recipe'}
            </button>

            {error && <p className="text-red-500 text-center mt-4">{error}</p>}

            {recipe && (
              <div className="mt-8 p-6 bg-gray-50 rounded-lg">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">{recipe.name || 'Your Recipe'}</h2>
                <div className="mb-4">
                  <h3 className="text-lg font-medium text-gray-700">Ingredients</h3>
                  <ul className="list-disc pl-5">
                    {(recipe.ingredients || []).map((item, index) => (
                      <li key={index} className="text-gray-600">{item}</li>
                    ))}
                  </ul>
                </div>
                <div className="mb-4">
                  <h3 className="text-lg font-medium text-gray-700">Instructions</h3>
                  <ol className="list-decimal pl-5">
                    {(recipe.instructions || []).map((step, index) => (
                      <li key={index} className="text-gray-600">{step}</li>
                    ))}
                  </ul>
                </div>
                {recipe.nutritionalInfo && (
                  <div>
                    <h3 className="text-lg font-medium text-gray-700">Nutritional Info</h3>
                    <p className="text-gray-600">{recipe.nutritionalInfo}</p>
                  </div>
                )}
              </div>
            )}

            {recipeHistory.length > 0 && (
              <div className="mt-8">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">Recipe History</h2>
                <div className="grid gap-4">
                  {recipeHistory.map((savedRecipe, index) => (
                    <div key={index} className="p-4 bg-gray-100 rounded-lg">
                      <h3 className="text-lg font-medium text-gray-700">{savedRecipe.name}</h3>
                      <p className="text-gray-600">Ingredients: {savedRecipe.ingredients.join(', ')}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </ErrorBoundary>
      );
    };

    try {
      ReactDOM.render(<App />, document.getElementById('root'));
    } catch (err) {
      console.error('Render Error:', err);
      document.getElementById('root').innerHTML = '<h1 className="text-white text-center">Failed to load app. Please check console.</h1>';
    }
  </script>
</body>
</html>
