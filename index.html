<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Recipe Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.2/Babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      background: linear-gradient(270deg, #6B46C1, #EC4899, #3B82F6);
      background-size: 600% 600%;
      animation: gradientShift 15s ease infinite;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Error Boundary
    class ErrorBoundary extends React.Component {
      state = { hasError: false, error: null };
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      render() {
        if (this.state.hasError) {
          console.error('Render Error:', this.state.error);
          return (
            <div className="text-center text-white">
              <h1 className="text-2xl font-bold">Something went wrong</h1>
              <p>Please refresh the page or check the console for details.</p>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Cookie helpers
    const setCookie = (name, value, days) => {
      try {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${expires.toUTCString()};path=/`;
      } catch (err) {
        console.error('Error setting cookie:', err);
      }
    };

    const getCookie = (name) => {
      try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
        return null;
      } catch (err) {
        console.error('Error getting cookie:', err);
        return null;
      }
    };

    const App = () => {
      const [ingredients, setIngredients] = useState('');
      const [dietary, setDietary] = useState('none');
      const [cuisine, setCuisine] = useState('none');
      const [recipe, setRecipe] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [recipeHistory, setRecipeHistory] = useState([]);
      const [generationsLeft, setGenerationsLeft] = useState(3);

      useEffect(() => {
        try {
          const savedRecipes = getCookie('recipes') || [];
          setRecipeHistory(savedRecipes);

          const limitData = getCookie('generationLimit') || { count: 0, date: new Date().toDateString() };
          const today = new Date().toDateString();
          if (limitData.date !== today) {
            setCookie('generationLimit', { count: 0, date: today }, 1);
            setGenerationsLeft(3);
          } else {
            setGenerationsLeft(3 - limitData.count);
          }
        } catch (err) {
          setError('Error loading saved recipes.');
          console.error(err);
        }
      }, []);

      const handleGenerateRecipe = async () => {
        if (generationsLeft <= 0) {
          setError('Daily limit reached! Try again tomorrow.');
          return;
        }
        if (!ingredients.trim()) {
          setError('Please enter at least one ingredient.');
          return;
        }

        setLoading(true);
        setError(null);
        setRecipe(null);

        const prompt = `Generate a detailed recipe in JSON format with fields: name, ingredients (array), instructions (array), nutritionalInfo (string). Use these ingredients: ${ingredients}. Dietary preference: ${dietary === 'none' ? 'No restrictions' : dietary}. Cuisine type: ${cuisine === 'none' ? 'Any' : cuisine}.`;

        try {
          const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt }),
          });

          if (!response.ok) throw new Error(`API error: ${response.statusText}`);
          const data = await response.json();
          let newRecipe;
          try {
            newRecipe = JSON.parse(data.recipe);
          } catch (err) {
            throw new Error('Invalid recipe format from API');
          }

          const updatedHistory = [newRecipe, ...recipeHistory].slice(0, 10);
          setCookie('recipes', updatedHistory, 7);
          setRecipeHistory(updatedHistory);
          setRecipe(newRecipe);

          const limitData = getCookie('generationLimit') || { count: 0, date: new Date().toDateString() };
          const newCount = limitData.count + 1;
          setCookie('generationLimit', { count: newCount, date: new Date().toDateString() }, 1);
          setGenerationsLeft(3 - newCount);
        } catch (err) {
          setError('Failed to generate recipe. Please try again.');
          console.error('API Error:', err);
        } finally {
          setLoading(false);
        }
      };

      return (
        <ErrorBoundary>
          <div className="max-w-4xl w-full mx-auto glass-card rounded-2xl shadow-xl p-8">
            <h1 className="text-4xl font-extrabold text-center text-white mb-6 drop-shadow">AI Recipe Generator</h1>
            <p className="text-center text-white opacity-80 mb-6">Generations left today: {generationsLeft}</p>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <div className="glass-card p-4 rounded-lg">
                <label className="block text-sm font-medium text-white mb-2">Ingredients</label>
                <input
                  type="text"
                  value={ingredients}
                  onChange={(e) => setIngredients(e.target.value)}
                  placeholder="e.g., chicken, rice, broccoli"
                  className="w-full p-3 bg-white/10 text-white border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-white/50"
                />
              </div>
              <div className="glass-card p-4 rounded-lg">
                <label className="block text-sm font-medium text-white mb-2">Dietary Preference</label>
                <select
                  value={dietary}
                  onChange={(e) => setDietary(e.target.value)}
                  className="w-full p-3 bg-white/10 text-white border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                >
                  <option value="none">No Preference</option>
                  <option value="vegan">Vegan</option>
                  <option value="vegetarian">Vegetarian</option>
                  <option value="gluten-free">Gluten-Free</option>
                  <option value="keto">Keto</option>
                </select>
              </div>
              <div className="glass-card p-4 rounded-lg">
                <label className="block text-sm font-medium text-white mb-2">Cuisine Type</label>
                <select
                  value={cuisine}
                  onChange={(e) => setCuisine(e.target.value)}
                  className="w-full p-3 bg-white/10 text-white border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                >
                  <option value="none">Any Cuisine</option>
                  <option value="Italian">Italian</option>
                  <option value="Asian">Asian</option>
                  <option value="Mexican">Mexican</option>
                  <option value="Indian">Indian</option>
                </select>
              </div>
            </div>

            <button
              onClick={handleGenerateRecipe}
              disabled={loading || !ingredients.trim() || generationsLeft <= 0}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 transition-all duration-300"
            >
              {loading ? (
                <span className="flex items-center justify-center">
                  <svg className="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8h8a8 8 0 01-8 8 8 8 0 01-8-8z" />
                  </svg>
                  Generating...
                </span>
              ) : (
                'Generate Recipe'
              )}
            </button>

            {error && (
              <p className="text-red-300 text-center mt-4 bg-red-500/20 rounded-lg p-3">{error}</p>
            )}

            {recipe && (
              <div className="mt-8 p-6 glass-card rounded-lg">
                <h2 className="text-2xl font-semibold text-white mb-4 drop-shadow">{recipe.name || 'Your Recipe'}</h2>
                <div className="mb-4">
                  <h3 className="text-lg font-medium text-white">Ingredients</h3>
                  <ul className="list-disc pl-5 text-white/80">
                    {(recipe.ingredients || []).map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                </div>
                <div className="mb-4">
                  <h3 className="text-lg font-medium text-white">Instructions</h3>
                  <ol className="list-decimal pl-5 text-white/80">
                    {(recipe.instructions || []).map((step, index) => (
                      <li key={index}>{step}</li>
                    ))}
                  </ol>
                </div>
                {recipe.nutritionalInfo && (
                  <div>
                    <h3 className="text-lg font-medium text-white">Nutritional Info</h3>
                    <p className="text-white/80">{recipe.nutritionalInfo}</p>
                  </div>
                )}
              </div>
            )}

            {recipeHistory.length > 0 && (
              <div className="mt-8">
                <h2 className="text-2xl font-semibold text-white mb-4 drop-shadow">Recipe History</h2>
                <div className="grid gap-4">
                  {recipeHistory.map((savedRecipe, index) => (
                    <div key={index} className="p-4 glass-card rounded-lg hover:shadow-lg transition-shadow">
                      <h3 className="text-lg font-medium text-white">{savedRecipe.name}</h3>
                      <p className="text-white/80">Ingredients: {savedRecipe.ingredients.join(', ')}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </ErrorBoundary>
      );
    };

    try {
      const root = document.getElementById('root');
      ReactDOM.render(<App />, root);
    } catch (err) {
      console.error('Render Error:', err);
      document.getElementById('root').innerHTML = `
        <div class="text-center text-white">
          <h1 class="text-2xl font-bold">Failed to load app</h1>
          <p>Please check the console (F12) for details or refresh the page.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
